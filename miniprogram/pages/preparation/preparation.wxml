<view class="container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <navigation-bar title="å¤‡èœ" show-back="{{true}}" />
  
  <!-- é˜¶æ®µåˆ‡æ¢ -->
  <view class="stage-tabs">
    <view 
      class="stage-tab {{currentStage === 1 ? 'active' : ''}}"
      bindtap="switchStage"
      data-stage="1"
    >
      <text class="stage-number">1</text>
      <text class="stage-name">ç¡®å®šèœå“</text>
    </view>
    <view class="stage-divider">â†’</view>
    <view 
      class="stage-tab {{currentStage === 2 ? 'active' : ''}}"
      bindtap="switchStage"
      data-stage="2"
    >
      <text class="stage-number">2</text>
      <text class="stage-name">ç”Ÿæˆæ¸…å•</text>
    </view>
  </view>
  
  <!-- é˜¶æ®µä¸€ï¼šç¡®å®šèœå“ -->
  <scroll-view wx:if="{{currentStage === 1}}" scroll-y class="content-container">
    <view class="content-wrapper">
      <view class="tips-card">
        <text class="tips-icon">ğŸ’¡</text>
        <text class="tips-text">è¯·é€‰æ‹©éœ€è¦åˆ¶ä½œçš„èœå“ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆé‡‡è´­æ¸…å•</text>
      </view>
      
      <view class="dish-list">
        <view wx:for="{{likedDishes}}" wx:key="id" class="confirm-dish-card">
          <checkbox-group bindchange="onDishCheckChange" data-dish-id="{{item.dish.id}}">
            <label class="dish-checkbox">
              <checkbox value="{{item.dish.id}}" checked="{{confirmedDishIds.includes(item.dish.id)}}" />
            </label>
          </checkbox-group>
          
          <image class="dish-image" src="{{item.dish.image_url}}" mode="aspectFill" />
          
          <view class="dish-info">
            <view class="dish-name">{{item.dish.name}}</view>
            <view class="dish-meta">
              <view class="dish-type">{{item.dish.type === 'multi_serving' ? 'å¤šäººä»½' : 'ä¸€äººä»½'}}</view>
              <view class="like-count">â¤ï¸ {{item.likeCount}}äºº</view>
            </view>
            <view class="liked-users">
              <view wx:for="{{item.likedUsers}}" wx:for-item="user" wx:key="id" class="user-tag">
                {{user.nickname}}
              </view>
            </view>
            <view wx:if="{{item.dish.type === 'single_serving'}}" class="serving-count">
              éœ€è¦åˆ¶ä½œ {{item.likeCount}} ä»½
            </view>
          </view>
        </view>
        
        <view wx:if="{{likedDishes.length === 0}}" class="empty-state">
          <view class="empty-state-icon">ğŸ½ï¸</view>
          <view class="empty-state-text">æš‚æ— ç‚¹èµèœå“</view>
        </view>
      </view>
      
      <view wx:if="{{confirmedDishIds.length > 0}}" class="bottom-actions">
        <view class="selected-count">å·²é€‰æ‹© {{confirmedDishIds.length}} é“èœ</view>
        <button class="btn-primary" bindtap="generateShoppingList">ç”Ÿæˆæ¸…å•</button>
      </view>
    </view>
  </scroll-view>
  
  <!-- é˜¶æ®µäºŒï¼šç”Ÿæˆæ¸…å• -->
  <scroll-view wx:if="{{currentStage === 2}}" scroll-y class="content-container">
    <view class="content-wrapper">
      <!-- ç¡®å®šçš„èœå“åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰ -->
      <view class="section-card">
        <view class="section-header" bindtap="toggleConfirmedDishes">
          <view class="section-title">
            <text class="section-icon">ğŸ“‹</text>
            <text>å·²ç¡®å®šèœå“ ({{confirmedDishes.length}})</text>
          </view>
          <text class="toggle-icon">{{showConfirmedDishes ? 'â–¼' : 'â–¶'}}</text>
        </view>
        
        <view wx:if="{{showConfirmedDishes}}" class="confirmed-dishes-list">
          <view wx:for="{{confirmedDishes}}" wx:key="id" class="confirmed-dish-item">
            <text class="dish-name">{{item.dish.name}}</text>
            <text class="dish-type">{{item.dish.type === 'multi_serving' ? 'å¤šäººä»½' : 'ä¸€äººä»½'}}</text>
          </view>
          <view class="modify-btn" bindtap="backToConfirmStage">
            <text>âœï¸ é‡æ–°é€‰æ‹©èœå“</text>
          </view>
        </view>
      </view>
      
      <!-- é‡‡è´­æ¸…å• -->
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">
            <text class="section-icon">ğŸ›’</text>
            <text>é‡‡è´­æ¸…å•</text>
          </view>
          <view class="clear-btn" bindtap="resetPurchaseStatus">
            <text>é‡ç½®</text>
          </view>
        </view>
        
        <view class="shopping-list">
          <view wx:for="{{shoppingList}}" wx:key="id" class="shopping-item">
            <checkbox-group bindchange="onPurchaseCheckChange" data-item-id="{{item.id}}">
              <label class="shopping-checkbox">
                <checkbox value="{{item.id}}" checked="{{item.is_purchased}}" />
              </label>
            </checkbox-group>
            
            <view class="shopping-info {{item.is_purchased ? 'purchased' : ''}}">
              <view class="ingredient-name">{{item.ingredient_name}}</view>
              <view class="ingredient-details">
                <text class="ingredient-quantity">{{item.quantity}}</text>
                <text class="used-in">ç”¨äºï¼š{{getUsedInDishes(item.used_in_dishes)}}</text>
              </view>
            </view>
          </view>
          
          <view wx:if="{{shoppingList.length === 0}}" class="empty-state">
            <view class="empty-state-icon">ğŸ›’</view>
            <view class="empty-state-text">æš‚æ— é‡‡è´­æ¸…å•</view>
          </view>
        </view>
        
        <view wx:if="{{shoppingList.length > 0}}" class="purchase-stats">
          <text>å·²é‡‡è´­: {{purchasedCount}}/{{shoppingList.length}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{purchaseProgress}}%"></view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
</view>


