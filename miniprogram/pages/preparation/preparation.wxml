<view class="container">
  <!-- 自定义导航栏 -->
  <navigation-bar title="备菜" show-back="{{true}}" />
  
  <!-- 阶段切换 -->
  <view class="stage-tabs">
    <view 
      class="stage-tab {{currentStage === 1 ? 'active' : ''}}"
      bindtap="switchStage"
      data-stage="1"
    >
      <text class="stage-number">1</text>
      <text class="stage-name">确定菜品</text>
    </view>
    <view class="stage-divider">→</view>
    <view 
      class="stage-tab {{currentStage === 2 ? 'active' : ''}}"
      bindtap="switchStage"
      data-stage="2"
    >
      <text class="stage-number">2</text>
      <text class="stage-name">生成清单</text>
    </view>
  </view>
  
  <!-- 阶段一：确定菜品 -->
  <scroll-view wx:if="{{currentStage === 1}}" scroll-y class="content-container">
    <view class="content-wrapper">
      <view class="tips-card">
        <text class="tips-icon">💡</text>
        <text class="tips-text">请选择需要制作的菜品，系统将自动生成采购清单</text>
      </view>
      
      <view class="dish-list">
        <view wx:for="{{likedDishes}}" wx:key="id" class="confirm-dish-card">
          <checkbox-group bindchange="onDishCheckChange" data-dish-id="{{item.dish.id}}">
            <label class="dish-checkbox">
              <checkbox value="{{item.dish.id}}" checked="{{confirmedDishIds.includes(item.dish.id)}}" />
            </label>
          </checkbox-group>
          
          <image class="dish-image" src="{{item.dish.image_url}}" mode="aspectFill" />
          
          <view class="dish-info">
            <view class="dish-name">{{item.dish.name}}</view>
            <view class="dish-meta">
              <view class="dish-type">{{item.dish.type === 'multi_serving' ? '多人份' : '一人份'}}</view>
              <view class="like-count">❤️ {{item.likeCount}}人</view>
            </view>
            <view class="liked-users">
              <view wx:for="{{item.likedUsers}}" wx:for-item="user" wx:key="id" class="user-tag">
                {{user.nickname}}
              </view>
            </view>
            <view wx:if="{{item.dish.type === 'single_serving'}}" class="serving-count">
              需要制作 {{item.likeCount}} 份
            </view>
          </view>
        </view>
        
        <view wx:if="{{likedDishes.length === 0}}" class="empty-state">
          <view class="empty-state-icon">🍽️</view>
          <view class="empty-state-text">暂无点赞菜品</view>
        </view>
      </view>
      
      <view wx:if="{{confirmedDishIds.length > 0}}" class="bottom-actions">
        <view class="selected-count">已选择 {{confirmedDishIds.length}} 道菜</view>
        <button class="btn-primary" bindtap="generateShoppingList">生成清单</button>
      </view>
    </view>
  </scroll-view>
  
  <!-- 阶段二：生成清单 -->
  <scroll-view wx:if="{{currentStage === 2}}" scroll-y class="content-container">
    <view class="content-wrapper">
      <!-- 确定的菜品列表（可折叠） -->
      <view class="section-card">
        <view class="section-header" bindtap="toggleConfirmedDishes">
          <view class="section-title">
            <text class="section-icon">📋</text>
            <text>已确定菜品 ({{confirmedDishes.length}})</text>
          </view>
          <text class="toggle-icon">{{showConfirmedDishes ? '▼' : '▶'}}</text>
        </view>
        
        <view wx:if="{{showConfirmedDishes}}" class="confirmed-dishes-list">
          <view wx:for="{{confirmedDishes}}" wx:key="id" class="confirmed-dish-item">
            <text class="dish-name">{{item.dish.name}}</text>
            <text class="dish-type">{{item.dish.type === 'multi_serving' ? '多人份' : '一人份'}}</text>
          </view>
          <view class="modify-btn" bindtap="backToConfirmStage">
            <text>✏️ 重新选择菜品</text>
          </view>
        </view>
      </view>
      
      <!-- 采购清单 -->
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">
            <text class="section-icon">🛒</text>
            <text>采购清单</text>
          </view>
          <view class="clear-btn" bindtap="resetPurchaseStatus">
            <text>重置</text>
          </view>
        </view>
        
        <view class="shopping-list">
          <view wx:for="{{shoppingList}}" wx:key="id" class="shopping-item">
            <checkbox-group bindchange="onPurchaseCheckChange" data-item-id="{{item.id}}">
              <label class="shopping-checkbox">
                <checkbox value="{{item.id}}" checked="{{item.is_purchased}}" />
              </label>
            </checkbox-group>
            
            <view class="shopping-info {{item.is_purchased ? 'purchased' : ''}}">
              <view class="ingredient-name">{{item.ingredient_name}}</view>
              <view class="ingredient-details">
                <text class="ingredient-quantity">{{item.quantity}}</text>
                <text class="used-in">用于：{{getUsedInDishes(item.used_in_dishes)}}</text>
              </view>
            </view>
          </view>
          
          <view wx:if="{{shoppingList.length === 0}}" class="empty-state">
            <view class="empty-state-icon">🛒</view>
            <view class="empty-state-text">暂无采购清单</view>
          </view>
        </view>
        
        <view wx:if="{{shoppingList.length > 0}}" class="purchase-stats">
          <text>已采购: {{purchasedCount}}/{{shoppingList.length}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{purchaseProgress}}%"></view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
</view>


